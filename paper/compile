#!/bin/bash
# -*- coding: utf-8 -*-
# Time-stamp: "2025-09-27 15:00:00 (ywatanabe)"
# File: ./compile

################################################################################
# Unified compilation interface
# Delegates to specific compilation scripts based on document type
################################################################################

# Default values
DOC_TYPE=""
SHOW_HELP=false
WATCH_MODE=false
WATCH_ARGS=""

# Function to display usage
show_usage() {
    cat << EOF
Usage: ./compile [TYPE] [OPTIONS]

Unified compilation interface for scientific documents.

DOCUMENT TYPES:
    manuscript, -m        Compile manuscript (default if no type specified)
    supplementary, -s     Compile supplementary materials
    revision, -r          Compile revision responses

GLOBAL OPTIONS:
    -h, --help           Show this help message
    -w, --watch          Enable watch mode for hot-recompiling
                         (Only works with manuscript type)

TYPE-SPECIFIC OPTIONS:
    Pass any additional options after the document type.
    These will be forwarded to the specific compilation script.

EXAMPLES:
    ./compile                           # Compile manuscript (default)
    ./compile manuscript                # Explicitly compile manuscript
    ./compile supplementary             # Compile supplementary materials
    ./compile revision --track-changes  # Compile revision with track changes

    Short forms:
    ./compile -m                        # Compile manuscript
    ./compile -s                        # Compile supplementary
    ./compile -r --track-changes        # Compile revision with options
    
    Watch mode:
    ./compile -m -w                     # Watch and recompile manuscript
    ./compile -m --watch                # Watch mode with long option

DELEGATION:
    This script delegates to:
    - ./scripts/shell/compile_manuscript for manuscripts
    - ./scripts/shell/compile_supplementary for supplementary materials
    - ./scripts/shell/compile_revision for revision responses

    Each specific script has its own options and behaviors.

EOF
}

# Parse arguments
REMAINING_ARGS=""

while [ $# -gt 0 ]; do
    case $1 in
        manuscript|-m)
            DOC_TYPE="manuscript"
            shift
            ;;
        supplementary|-s)
            DOC_TYPE="supplementary"
            shift
            ;;
        revision|-r)
            DOC_TYPE="revision"
            shift
            ;;
        -w|--watch)
            WATCH_MODE=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            # Collect remaining arguments
            if [ -z "$DOC_TYPE" ]; then
                echo "ERROR: Unknown document type '$1'"
                echo "Valid types: manuscript, supplementary, revision"
                echo "Use './compile --help' for usage information"
                exit 1
            else
                REMAINING_ARGS="$REMAINING_ARGS $1"
                shift
            fi
            ;;
    esac
done

# Default to manuscript if no type specified
if [ -z "$DOC_TYPE" ]; then
    DOC_TYPE="manuscript"
fi

# Check if watch mode is supported for this document type
if [ "$WATCH_MODE" = true ] && [ "$DOC_TYPE" != "manuscript" ]; then
    echo "ERROR: Watch mode is only supported for manuscript compilation"
    echo "Use: ./compile -m -w"
    exit 1
fi

# Display what we're doing
echo "=========================================="
echo "Compilation Interface"
echo "  Document type: $DOC_TYPE"
if [ "$WATCH_MODE" = true ]; then
    echo "  Mode: WATCH (hot-recompile enabled)"
fi
if [ -n "$REMAINING_ARGS" ]; then
    echo "  Additional options:$REMAINING_ARGS"
fi
if [ "$WATCH_MODE" = true ]; then
    echo "  Delegating to: ./scripts/shell/watch_compile.sh"
else
    echo "  Delegating to: ./scripts/shell/compile_$DOC_TYPE.sh"
fi
echo "=========================================="

# Handle watch mode
if [ "$WATCH_MODE" = true ]; then
    # Run watch script for manuscript
    ./scripts/shell/watch_compile.sh "$REMAINING_ARGS"
    exit $?
fi

# Delegate to the appropriate compilation script
case $DOC_TYPE in
    manuscript)
        ./scripts/shell/compile_manuscript.sh $REMAINING_ARGS
        ;;
    supplementary)
        ./scripts/shell/compile_supplementary.sh $REMAINING_ARGS
        ;;
    revision)
        ./scripts/shell/compile_revision.sh $REMAINING_ARGS
        ;;
    *)
        echo "Error: Unknown document type: $DOC_TYPE"
        exit 1
        ;;
esac

# Exit with the same status as the delegated script
exit $?
